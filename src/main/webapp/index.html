<html>
    <head>
        <script type="text/javascript" charset="UTF-8" src="//cdnjs.cloudflare.com/ajax/libs/jsxgraph/1.2.1/jsxgraphcore.js"></script>
        <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/jsxgraph/1.2.1/jsxgraph.css" />
    </head>
    <body>
        <h2>Hello World! Index.html</h2>
        <p>
            There is no user interface for this quickstart. Instead, you can verify the
            Web Service is running and deployed correctly by accessing the following URL:
        </p>
        <div style="margin-left: 1em;">
            <a href="GameOfLifeService?wsdl">GameOfLifeService?wsdl</a>
        </div>
        <p/>
        <div id="box" class="jxgbox" style="width:500px; height:500px;"></div>
        <script type="text/javascript">
            function log(str) {
//                console.log(str);
            }
            function getRequestBody(g) {
                var sr = new Array();
                sr.push('<?xml version="1.0" encoding="utf-8"?>');
                sr.push('<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ' +
                        'xmlns:api="http://sscomputing.com/game-of-life/GameOfLife" ' +
                        'xmlns:xsd="http://www.w3.org/2001/XMLSchema" ' +
                        'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">');
                sr.push('<soapenv:Body>');
                sr.push('<api:iterate soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">');
                for (i=0; i < g.length; i++) {
                    sr.push('<arg0>');
                    for (j=0; j < g[i].length; j++) {
                        sr.push('<item>' + g[i][j] + '</item>');
                    }
                    sr.push('</arg0>');
                }
                sr.push('</api:iterate>');
                sr.push('</soapenv:Body>');
                sr.push('</soapenv:Envelope>');
                log(sr);
                return sr.join('');
            }

            async function sendRequest(req) {
                var response = await fetch('http://127.0.0.1:8080/game-of-life/GameOfLifeService', {
                    method: 'POST',
                    body: req,
                    headers: {
                        'Content-Type': 'text/xml'
                    }
                });
                response = await response.text();
                log('Got Response' + response);
                return await response;
            }

            function XMLtoGrid(xml) {
                var d = new Date();
                console.log('StartTime:' + d.toLocaleTimeString());
                const parser = new DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                log('XML:' + doc.textContent);
                const resultArray = doc.evaluate('//return', doc, null, XPathResult.ANY_TYPE, null);
                const resultGrid = new Array();
                var newgrid = [];
                var node = resultArray.iterateNext();
                for (i=0; node != null; i++) {
                    const rowArray = doc.evaluate('//return[' + (i+1) + ']/item', node, null, XPathResult.ANY_TYPE, null);
                    log('RA:' + rowArray);
                    newgrid.push([]);
                    var cell = rowArray.iterateNext();
                    for (j=0; cell != null; j++) {
                        log('cell:' + cell);
                        if (cell.textContent.match('true')) newgrid[i].push(true); else newgrid[i].push(false);
                        cell = rowArray.iterateNext();
                    }
                    node = resultArray.iterateNext();
                }
                d = new Date();
                console.log('endTime:' + d.toLocaleTimeString());
                return newgrid;
            }

            var board = JXG.JSXGraph.initBoard('box', {boundingbox: [-1, 1, 50, -50], axis:false, grid:false, showNavigation:false, showCopyright:false});
            function showGrid(grid) {
                var d = new Date();
                console.log('Show StartTime:' + d.toLocaleTimeString());
                for (i=0; i < grid.length; i++) {
                    for (j=0; j < grid[i].length; j++) {
                        var color = 'yellow';
                        if (grid[i][j]) color = 'red';
                        board.create('point', [j, 0-i], {name:'', strokecolor:color, face:'square', size:1});
                    }
                }
                d = new Date();
                console.log('Show endTime:' + d.toLocaleTimeString());
            }
            async function iterate(grid) {
                var sr = getRequestBody(grid);
                var result = await sendRequest(sr);
                var newgrid = XMLtoGrid(result.toString());
                log('Result:' + newgrid.join(','));
                showGrid(newgrid);
                return newgrid;
            }
            async function runLife() {
                var grid = [[false, true, true], [true, true, false], [false, true, false]]; // rpentomino
                for (ii=0; ii < 25; ii++) {
                    console.log('Iteration ' + (ii+1));
                    grid = await iterate(grid);
                }
            }
            runLife();
            alert('fetched');
/*
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <ns2:sayHelloResponse xmlns:ns2="http://sscomputing.com/game-of-life/GameOfLife">
            <return>Hello Game</return></ns2:sayHelloResponse></soap:Body></soap:Envelope>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <ns2:sayBooleanArrayResponse xmlns:ns2="http://sscomputing.com/game-of-life/GameOfLife">
            <return>
                <item>false</item>
                <item>true</item>
                <item xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true"/>
            </return>
            <return>
                <item xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true"/>
                <item>true</item>
                <item xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true"/>
            </return>
            <return><item xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true"/><item>true</item><item xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true"/></return></ns2:sayBooleanArrayResponse></soap:Body></soap:Envelope>

            const userAction = async() => {
                const response = await fetch('http://127.0.0.1:8080/game-of-life/GameOfLifeService', {
                    method: 'POST',
                    body: sr,
                    headers: {
                        'Content-Type': 'text/xml'
                    }
                }).catch(ex => alert('Error:' + ex.message));
                alert('fetched');
                const myJson = await response.json();
                alert(myJson);
            }
*/
        </script>
    </body>
</html>
